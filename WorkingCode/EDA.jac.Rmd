---
title: 'Project 2: EDA'
author: "Jaclyn A Coate"
date: "3/23/2020"
output: html_document
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

```{r environment prep}
library(tidyverse)
library(data.table)
library(mice)
library(skimr)
library(corrplot)
library(cowplot)
```

```{r data prep}
bankraw <- read.csv("https://raw.githubusercontent.com/JaclynCoate/6372_Project_2/master/Data/bank-additional-full.csv", header = TRUE, sep = ";", strip.white = TRUE)
str(bankraw)
head(bankraw)
```

# Question of Interest:
- The data is related with direct marketing campaigns (phone calls) of a Portuguese banking institution. The classification goal is to predict if the client will subscribe a term deposit (variable y).

## EDA to determine narrow down variables to use for the Logistic Regression model

#### Properly naming response variable

```{r}
setnames(bankraw, "y", "Subscription")
```

#### Removing logically irrelevant variables
- Upon reviewing the available metrics, there are certain variabels that would not make logical sense as a contribution to creating a logisitc regression model

```{r drop irrelevant variables}
str(bankraw)
#Dropping logical irrelevant variables: "contact", "campaign", "pdays", "previous"
bankraw2 <- select(bankraw, -c("pdays", "previous", "contact", "campaign"))
head(bankraw2)
view(bankraw2)
```

#### NA Evaluation and Drop

```{r NA eval}
#Checking for NAs
md.pattern(bankraw2)
#Results show no NAs
```

#### Zero variance variable check - all show variance so remain in model

```{r zero variable check}
skim(bankraw2)
```

#### Continuous Variable Review
- First we will review all continuous variables and see whic of those are the most associated with our categorical variable.
  - To accomplish this we will create boxplots of the individual continuous variables compared to the categorical response variable and look for large differences in the summary statistic ranges for the categorical variables.
  
```{r Subscription v cons.conf.idx}
plot(bankraw2$Subscription, bankraw2$cons.conf.idx, xlab = "Subscription", ylab = "cons.conf.idx", title = "Subscription v cons.conf.idx", col=c(82,107)) 
```

```{r Subscription v cons.price.idx}
plot(bankraw2$Subscription, bankraw2$cons.price.idx, xlab = "Subscription", ylab = "cons.price.idx", title = "Subscription v cons.price.idx", col=c(82,107)) 
```

```{r Subscription v emp.var.rate}
plot(bankraw2$Subscription, bankraw2$emp.var.rate, xlab = "Subscription", ylab = "cons.conf.idx", title = "Subscription v emp.var.rate", col=c(82,107)) 
```

```{r Subscription v euribor3m}
plot(bankraw2$Subscription, bankraw2$euribor3m, xlab = "Subscription", ylab = "euribor3m", title = "Subscription v euribor3m", col=c(82,107)) 
```

```{r Subscription v nr.employed}
plot(bankraw2$Subscription, bankraw2$nr.employed, xlab = "Subscription", ylab = "nr.employed", title = "Subscription v nr.employed", col=c(82,107)) 
```

##### Continuous Variable Removal
- As we can see from the above boxplots the continuous variable ranges for the Yes and No outcomes of the subscription do not greatly differ. Once could argue that 

```{r removal of all continuous variables}
bank3 <- select(bankraw2, -c("nr.employed", "euribor3m", "emp.var.rate", "cons.price.idx", "cons.conf.idx"))
```

### With the above realization that the continuous variables have very little to do with the resulting response variable's outcome. The below is deemed unncessary and I've commented out code blocks. 
#### Continuous Variable Multicollinearity Check
- Multicollinearity will weaken the model
- At first glance there does seem to be some correlation between a few of the continuous variables
- When highglighting the yes versus no result for signing up, we cannot see a clear separation of anykind. This will lead us away from utilizing the principal componenet analysis technique for variable selection

#```{r pairs graph}
#view(bankraw2)
#Reducing to only continuous variables and graphing by continuous variables, then colored by response in order to determine if there is separation of results and the ability to utilzie PCA
#bankraw2 %>% keep(is.numeric) %>% pairs(,col=bankraw2$Subscription)
#```

- To additionally check we will run a correlation matrix
  - Using the correlation matrix we can much more clearly see high correlation
    - cons.price.idx : nr.employed
    - cons.price.idx : emp.var.rate
    - cons.price.idx : euribor3m
    - nr.employed : emp.var.rate
    - nr.employed : euibor3m
    - emp.var.rate : euribor3m

#```{r density curves}
#densityPlots <- function(df, explanatory, response){
#df %>% ggplot(aes_string(x = explanatory, fill = response)) + geom_density(alpha=0.5)
#}
#densityPlotsList <- lapply(bankraw2 %>% keep(is.numeric) %>% colnames, function(x) densityPlots(bankraw2, x, "Subscription"))
#for(i in densityPlotsList){
#  print(i)
#}
#densityPlots(bankraw2, "age", "Subscription")
#```

#```{r correlation matrix}
#Plot numeric variables v numeric variables
#bankraw2 %>% keep(is.numeric) %>% cor %>% corrplot("upper", addCoef.col = "white", number.digits = 2, number.cex = 0.5, method="square", #order="hclust", tl.srt=45, tl.cex = 0.8)
#```

#```{r attrition: removing highly correlated variable}
#Removing reviews_per_month due to high correlation of is and number_of_reviews
#bank3 <- select(bankraw2, -c("cons.price.idx", "nr.employed", "emp.var.rate"))
#skim(bank3)
#```

- After reviewing the need to remove the below variables is clear
  - "cons.price.idx", "nr.employed", "emp.var.rate"
- See correlation matrix below after correlated continuous variables have been removed

#```{r correlation matrix 2}
#Plot numeric continuous variables to double check all correlated values have been removed
#bank3 %>% keep(is.numeric) %>% cor %>% corrplot("upper", addCoef.col = "white", number.digits = 2, number.cex = 0.5, method="square", #order="hclust", tl.srt=45, tl.cex = 0.8)
#```

- Seeing highly correlated variables we are going to use PCA in order which numeric variables should be leveraged for our logistic regression

#### Categorical Variable Review

```{r Categorical Variable Review Grid}
# 1. Name target variable
targetCatCat <- "Subscription"

# 2. Name explanatory variable
explanatory <- bank3 %>% keep(is.factor) %>% colnames

# 3. Create function
numCatCat <- function(df, explanatory, response) {
  ggplot(data = df) +geom_bar(aes_string(x = explanatory, fill = response), position = "fill", alpha = 0.9) + coord_flip() + xlab(explanatory)
}

  # 3a. Example of working function above
  # numCatCat(bank3, explanatory = "education", response = "Subscription")


# 4. Create plot list for plot_grid function to reference
plotlistCatCat <- lapply(explanatory, function(x) numCatCat(bank3, x, targetCatCat))

# 5. Grid of all categorical variables plotted against y = Subscription
plot_grid(plotlist = plotlistCatCat)
```

- Singular break downs of the above function

```{r review data}
head(bank3)
```

```{r Job v Subscription}
numCatCat(bank3, explanatory = "job", response = "Subscription")
```

```{r Martial v Subscription}
numCatCat(bank3, explanatory = "marital", response = "Subscription")
```

```{r Education v Subscription}
numCatCat(bank3, explanatory = "education", response = "Subscription")
```

```{r Default v Subscription}
numCatCat(bank3, explanatory = "default", response = "Subscription")
```

```{r House v Subscription}
numCatCat(bank3, explanatory = "housing", response = "Subscription")
```

```{r Loadn v Subscription}
numCatCat(bank3, explanatory = "loan", response = "Subscription")
```

```{r Month v Subscription}
numCatCat(bank3, explanatory = "month", response = "Subscription")
```

```{r Day of Week v Subscription}
numCatCat(bank3, explanatory = "day_of_week", response = "Subscription")
```

```{r Poutcome v Subscription}
numCatCat(bank3, explanatory = "poutcome", response = "Subscription")
```

- Upon reviewing all of the Categorical variables we can clearly remove the below variables
  - marital, housing, loan, day_of_week
- While the below variables seem to show strong correlation with the response variable
  - job, eduction, default, month, poutcome

```{r removal of unrelated categorical variables}
bank4 <- select(bank3, -c("marital", "housing", "loan", "day_of_week"))
```

#### Summary Check on Variables

```{r summary of variables}
summary(bank4)
```

#### Export data set for simple logistic analysis 

```{r}
write.csv(bank4, file="/Users/Jaco/Desktop/SMU/Spring2020/DS_6372_Applied_Statistics/Project.2/Data/modelingdata.csv")
```